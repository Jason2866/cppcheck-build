# .github/workflows/build-cppcheck.yml
name: Build & Release Cppcheck Binaries

on:
  workflow_dispatch:
  push:
    tags:
      - "*"

permissions:
  contents: write

jobs:
  get-version:
    name: Get Cppcheck Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.tag }}
    env:
      CPPCHECK_REPO: https://github.com/danmar/cppcheck.git
    steps:
      - name: Get latest Cppcheck tag
        id: get_version
        shell: bash
        run: |
          LATEST_TAG=$(git ls-remote --tags --sort="v:refname" ${{ env.CPPCHECK_REPO }} \
            | awk -F/ '{print $NF}' \
            | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' \
            | tail -n1)
          echo "tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "Using Cppcheck version: ${LATEST_TAG}"

  build:
    name: Build Cppcheck (${{ matrix.os }} / ${{ matrix.arch }})
    needs: get-version
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: x64
            artifact: cppcheck-linux-x64
          - os: macos-latest
            arch: x64
            artifact: cppcheck-macos-x64
          - os: macos-latest
            arch: arm64
            artifact: cppcheck-macos-arm64
          - os: windows-latest
            arch: x64
            artifact: cppcheck-windows-x64

    env:
      CPPCHECK_REPO: https://github.com/danmar/cppcheck.git
      CPPCHECK_VERSION: ${{ needs.get-version.outputs.version }}

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake g++ make libpcre3-dev

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install cmake pcre

      - name: Setup vcpkg (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $vcpkgRoot = $env:VCPKG_INSTALLATION_ROOT
          & "$vcpkgRoot\vcpkg.exe" install pcre:x64-windows-static --triplet x64-windows-static
          echo "VCPKG_ROOT=$vcpkgRoot" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "VCPKG_TARGET_TRIPLET=x64-windows-static" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Clone Cppcheck at latest tag
        run: |
          git clone --depth 1 --branch "${{ env.CPPCHECK_VERSION }}" "${{ env.CPPCHECK_REPO }}" cppcheck-src

      - name: Configure (Unix)
        if: runner.os != 'Windows'
        working-directory: cppcheck-src
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_GUI=OFF \
            -DHAVE_RULES=ON

      - name: Configure (Windows)
        if: runner.os == 'Windows'
        working-directory: cppcheck-src
        shell: pwsh
        run: |
          cmake -S . -B build `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE="${env:VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET="${env:VCPKG_TARGET_TRIPLET}" `
            -DBUILD_GUI=OFF `
            -DHAVE_RULES=ON

      - name: Build (Unix)
        if: runner.os != 'Windows'
        working-directory: cppcheck-src
        run: cmake --build build --config Release --parallel

      - name: Build (Windows)
        if: runner.os == 'Windows'
        working-directory: cppcheck-src
        shell: pwsh
        run: cmake --build build --config Release --parallel

      - name: Collect binary (Unix)
        if: runner.os != 'Windows'
        working-directory: cppcheck-src
        run: |
          mkdir -p out
          cp build/bin/cppcheck out/cppcheck
          chmod +x out/cppcheck
          file out/cppcheck

      - name: Collect binary (Windows)
        if: runner.os == 'Windows'
        working-directory: cppcheck-src
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path out
          $binary = Get-ChildItem -Recurse -Filter "cppcheck.exe" build | Select-Object -First 1
          if ($null -eq $binary) {
            Write-Error "cppcheck.exe not found in build directory!"
            exit 1
          }
          Write-Host "Found binary at: $($binary.FullName)"
          Copy-Item $binary.FullName "out/cppcheck.exe"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: cppcheck-src/out/*

  release:
    name: Create Release
    needs: [get-version, build]
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded artifacts
        run: ls -R artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Cppcheck ${{ needs.get-version.outputs.version }} Binaries
          files: |
            artifacts/cppcheck-linux-x64/cppcheck
            artifacts/cppcheck-macos-x64/cppcheck
            artifacts/cppcheck-macos-arm64/cppcheck
            artifacts/cppcheck-windows-x64/cppcheck.exe
          body: |
            **Auto‑built Cppcheck ${{ needs.get-version.outputs.version }} binaries:**

            - `cppcheck-linux-x64/cppcheck` ✅ executable
            - `cppcheck-macos-x64/cppcheck` ✅ executable  
            - `cppcheck-macos-arm64/cppcheck` ✅ executable
            - `cppcheck-windows-x64/cppcheck.exe` ✅ PCRE‑enabled

            Ready for pioarduino!
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
