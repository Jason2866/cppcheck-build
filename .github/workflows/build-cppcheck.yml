# .github/workflows/build-cppcheck.yml
name: Build & Release Cppcheck Binaries

on:
  workflow_dispatch:
  push:
    tags:
      - "cppcheck-*"

permissions:
  contents: write

jobs:
  build:
    name: Build Cppcheck (${{ matrix.os }} / ${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: x64
          - os: macos-latest
            arch: x64
          - os: macos-latest
            arch: arm64
          - os: windows-latest
            arch: x64

    outputs:
      version: ${{ steps.get_version.outputs.tag }}
    env:
      CPPCHECK_REPO: https://github.com/danmar/cppcheck.git

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Get latest Cppcheck tag
        id: get_version
        shell: bash
        run: |
          if [ "${{ runner.os }}" != "Windows" ]; then
            LATEST_TAG=$(git ls-remote --tags --sort="v:refname" ${{ env.CPPCHECK_REPO }} \
              | awk -F/ '{print $NF}' \
              | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' \
              | tail -n1)
          else
            LATEST_TAG=$(git ls-remote --tags --sort="-v:refname" ${{ env.CPPCHECK_REPO }} \
              | pwsh -Command "
                \$tags = \$input | ForEach-Object { (\$_.Split('/'))[-1] } |
                         Where-Object { \$_ -match '^\d+\.\d+\.\d+$' } |
                         Sort-Object { [Version]\$_ } -Descending |
                         Select-Object -First 1;
                \$tags"
              )
          fi
          echo "tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "Using Cppcheck version: ${LATEST_TAG}"

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake g++ make libpcre3-dev

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install cmake pcre

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # git, cmake and vcpkg are pre-installed on windows-latest runners
          # nothing extra needed here

      - name: Setup vcpkg (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $vcpkgRoot = $env:VCPKG_INSTALLATION_ROOT
          & "$vcpkgRoot\vcpkg.exe" install pcre:x64-windows-static --triplet x64-windows-static
          echo "VCPKG_ROOT=$vcpkgRoot" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "VCPKG_TARGET_TRIPLET=x64-windows-static" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Clone Cppcheck at latest tag
        run: |
          git clone --depth 1 --branch "${{ steps.get_version.outputs.tag }}" "${{ env.CPPCHECK_REPO }}" cppcheck-src

      - name: Configure (Unix)
        if: runner.os != 'Windows'
        working-directory: cppcheck-src
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_GUI=OFF \
            -DHAVE_RULES=ON

      - name: Configure (Windows)
        if: runner.os == 'Windows'
        working-directory: cppcheck-src
        shell: pwsh
        run: |
          cmake -S . -B build `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE="${env:VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET="${env:VCPKG_TARGET_TRIPLET}" `
            -DBUILD_GUI=OFF `
            -DHAVE_RULES=ON

      - name: Build (Unix)
        if: runner.os != 'Windows'
        working-directory: cppcheck-src
        run: cmake --build build --config Release --parallel

      - name: Build (Windows)
        if: runner.os == 'Windows'
        working-directory: cppcheck-src
        shell: pwsh
        run: cmake --build build --config Release --parallel

      - name: Collect binary (Unix)
        if: runner.os != 'Windows'
        working-directory: cppcheck-src
        run: |
          mkdir -p out
          cp build/bin/cppcheck out/cppcheck
          chmod +x out/cppcheck
          file out/cppcheck

      - name: Collect binary (Windows)
        if: runner.os == 'Windows'
        working-directory: cppcheck-src
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path out
          Copy-Item "build/Release/cppcheck.exe" "out/cppcheck.exe"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-${{ steps.get_version.outputs.tag }}-${{ matrix.os }}-${{ matrix.arch }}
          path: cppcheck-src/out/*

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: cppcheck-${{ needs.build.outputs.version }}
          name: Cppcheck ${{ needs.build.outputs.version }} Binaries
          body: |
            **Auto‑built Cppcheck ${{ needs.build.outputs.version }} binaries:**

            - `cppcheck-linux-x64/cppcheck` ✅ executable
            - `cppcheck-macos-x64/cppcheck` ✅ executable  
            - `cppcheck-macos-arm64/cppcheck` ✅ executable
            - `cppcheck-windows-x64/cppcheck.exe` ✅ PCRE‑enabled

            Ready for pioarduino!
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
