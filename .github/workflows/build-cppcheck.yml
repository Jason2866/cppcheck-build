# .github/workflows/build-cppcheck.yml
name: Build & Release Cppcheck Binaries

on:
  workflow_dispatch:
  push:
    tags:
      - "cppcheck-*"

permissions:
  contents: write

jobs:
  build:
    name: Build Cppcheck (${{ matrix.os }} / ${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: x64
          - os: macos-latest
            arch: x64
          - os: macos-latest
            arch: arm64
          - os: windows-latest
            arch: x64

    outputs:
      version: ${{ steps.get_version.outputs.tag }}
    env:
      CPPCHECK_REPO: https://github.com/danmar/cppcheck.git

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Get latest Cppcheck tag (Unix)
        if: runner.os != 'Windows'
        id: get_version_unix
        run: |
          LATEST_TAG=$(git ls-remote --tags --sort="v:refname" ${{ env.CPPCHECK_REPO }} \
            | awk -F/ '{print $NF}' \
            | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' \
            | tail -n1)
          echo "tag=${LATEST_TAG}" >> $GITHUB_OUTPUT

      - name: Get latest Cppcheck tag (Windows)
        if: runner.os == 'Windows'
        id: get_version_win
        shell: pwsh
        run: |
          $tags = git ls-remote --tags --sort="-v:refname" $env:CPPCHECK_REPO | ForEach-Object { ($_ -split '/')[-1] } | Where-Object { $_ -match '^\d+\.\d+\.\d+$' } | Sort-Object { [Version]$_ } -Descending | Select-Object -First 1
          Write-Output "tag=$tags"
          echo "tag=$tags" >> $env:GITHUB_OUTPUT

      - name: Set version output
        id: get_version
        run: echo "tag=${{ steps.get_version_unix.outputs.tag || steps.get_version_win.outputs.tag }}" >> $GITHUB_OUTPUT

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake g++ make libpcre3-dev

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install cmake pcre

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install -y git cmake

      - name: Clone Cppcheck at latest tag
        run: |
          git clone --depth 1 "${{ env.CPPCHECK_REPO }}" cppcheck-src
          cd cppcheck-src
          git fetch --tags --depth 1
          git checkout "refs/tags/${{ steps.get_version.outputs.tag }}"

      - name: Configure (Unix)
        if: runner.os != 'Windows'
        working-directory: cppcheck-src
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_GUI=OFF \
            -DHAVE_RULES=ON

      - name: Configure (Windows)
        if: runner.os == 'Windows'
        working-directory: cppcheck-src
        shell: pwsh
        run: |
          cmake -S . -B build `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_GUI=OFF `
            -DHAVE_RULES=ON

      - name: Build (Unix)
        if: runner.os != 'Windows'
        working-directory: cppcheck-src
        run: cmake --build build --config Release --parallel

      - name: Build (Windows)
        if: runner.os == 'Windows'
        working-directory: cppcheck-src
        shell: pwsh
        run: cmake --build build --config Release --parallel

      - name: Collect binary (Unix)
        if: runner.os != 'Windows'
        working-directory: cppcheck-src
        run: |
          mkdir -p out
          cp build/bin/cppcheck out/cppcheck
          chmod +x out/cppcheck

      - name: Collect binary (Windows)
        if: runner.os == 'Windows'
        working-directory: cppcheck-src
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path out
          Copy-Item "build/Release/cppcheck.exe" "out/cppcheck.exe"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-${{ steps.get_version.outputs.tag }}-${{ matrix.os }}-${{ matrix.arch }}
          path: cppcheck-src/out/*

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: cppcheck-${{ needs.build.outputs.version }}
          name: Cppcheck ${{ needs.build.outputs.version }} Binaries
          body: |
            Autoâ€‘built Cppcheck ${{ needs.build.outputs.version }} binaries:
            
            - Linux x64: `cppcheck-linux-x64`
            - macOS x64: `cppcheck-macos-x64` 
            - macOS arm64: `cppcheck-macos-arm64`
            - Windows x64: `cppcheck-windows-x64`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
